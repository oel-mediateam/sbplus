var defaultFontSize=14,topicCount=0,counter=0,previousIndex=0,tocIndex=0,noteArray,topicSrc,imgPath,slideImgFormat="png",media="Slide",enabledNote=!1,imgCaption,quiz,quizArray,found=!1,qNum=0,PROFILE,lessonTitle,instructor,duration,audioPlayer,firstAudioLoad=!1,audioPlaying=!1,videoPlaying=!1,sources;$(document).ready(function(){var e=navigator.userAgent,t={iphone:e.match(/(iPhone|iPod|iPad)/),blackberry:e.match(/BlackBerry/),android:e.match(/Android/)},i="0"===$.fn.getParameterByName("m")?!1:!0;if((t.iphone||t.ipod||t.ipad||t.blackberry||t.android)&&i){var a=window.location.href,r=a.indexOf("."),n;return n=a.substr(r),a="http://mediastreamer"+n+"?m=0",$("body").html('<div style="text-align:center; width:450px; height:315px;"><a href="'+a+'" target="_blank"><img src="https://mediastreamer.doit.wisc.edu/uwli-ltc/media/storybook_plus/img/view_on_full_site.png" width="450px" height="315px" alt="Launch Presentation in New Window" border="0" /></a></div>'),!1}$.fn.getLessonContent("assets/topic.xml")}),$.fn.getLessonContent=function(e){$.ajaxSetup({url:e,type:"GET",dataType:"xml",accepts:"xml",content:"xml",contentType:'xml; charset="utf-8"',cache:!1}),$.ajax({encoding:"UTF-8",beforeSend:function(e){e.overrideMimeType("xml; charset=utf-8"),e.setRequestHeader("Accept","text/xml")},success:function(e){$.fn.parseContent(e)},error:function(e,t){$.fn.displayGetLessonError(e.status,t)}})},$.fn.parseContent=function(e){var t=$(e),i=t.find("setup"),a=t.find("topic"),r=$.trim(i.find("lesson").text()),n=$.trim(i.find("instructor").text()),o=$.trim(i.find("length").text()),s=$.trim(i.find("note").text()),d=$.trim(i.find("slideImgFormat").text());PROFILE=$.trim(t.find("profile").text()),lessonTitle="Lesson name is not specified.",instructor="Instructor name is not specified.",duration="",r.length&&(lessonTitle=r),n.length&&(instructor=n),o.length&&(duration=o),s.length&&("yes"===s||"y"===s)&&(enabledNote=!0),d.length&&(slideImgFormat=d),topicSrc=[],noteArray=[],quizArray=[],a.each(function(){var e=$(this).attr("title");if(topicSrc[topicCount]=$(this).attr("src"),enabledNote&&(noteArray[topicCount]=$(this).find("note").text()),"quiz"===topicSrc[topicCount]){var i=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("question").text()),a=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("choice").text()),r=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("wrongFeedback").text()),n=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("correctFeedback").text()),o=t.find("topic:eq("+topicCount+")").find("quiz").attr("type"),s=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("answer").text());quiz={},quiz.id=topicCount,quiz.type=o,quiz.question=i,a?(quiz.choice=$.fn.splitSelections(a),quiz.wrongFeedback=$.fn.splitSelections(r)):quiz.wrongFeedback=r,quiz.answer=$.fn.splitSelections(s),quiz.stuAnswer="",quiz.correct=!1,quiz.correctFeedback=n,quiz.taken=!1,quizArray.push(quiz)}++topicCount,$("#selectable").append('<li class="ui-widget-content" title="'+e+'"><div class="slideNum">'+$.fn.addLeadingZero(topicCount)+'.</div><div class="title">'+e+"</div></li>")}),$.fn.setupPlayer()},$.fn.setupPlayer=function(){var e=$.fn.getDirectory();$(document).attr("title",lessonTitle),enabledNote||$("#storybook_plus_wrapper").addClass("noteDisabled"),$("#errorMsg").hide(),$("#splash_screen").css("background-image","url(assets/splash.jpg)"),$("#splash_screen").append("<p>"+lessonTitle+"</p><p>"+instructor+"</p>"+(0!==duration?"<p><small>"+duration+"</small></p>":"")+'<a class="playBtn" href="#"></a>'),$("#splash_screen, #playBtn").on("click",function(){return $.fn.initializePlayer(),!1}),$.fn.getDownloadableFile(e,"mp3","audio/mpeg"),$.fn.getDownloadableFile(e,"pdf","application/pdf")},$.fn.initializePlayer=function(){$.each(topicSrc,function(e){var t=topicSrc[e].substring(0,topicSrc[e].indexOf(":")+1);return"video:"!==t&&"youtube:"!==t?(media="Slide",!1):void(media="Video")}),$("#splash_screen").hide(),$("#lessonTitle").html(lessonTitle),$("#instructorName").html('<a class="instructorName" href="#profile">'+instructor+"</a>"),$("#profile .bio").html("<p>"+instructor+"</p>"+PROFILE),$("#info, a.instructorName").fancybox({helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0}),$("#selectable li:first").addClass("ui-selected"),$("#selectable").selectable({stop:function(){$(".ui-selected",this).each(function(){tocIndex=$("#selectable li").index(this)}),tocIndex!==previousIndex&&($.fn.loadSlide(topicSrc[tocIndex],tocIndex),previousIndex=tocIndex)}}),$("#leftBtn").on("click",function(){counter--,0>=counter&&(counter=topicCount),$.fn.loadSlide(topicSrc[counter],counter)}),$("#rightBtn").on("click",function(){counter++,counter>topicCount&&(counter=1),$.fn.loadSlide(topicSrc[counter],counter)}),enabledNote&&($("#fontSizeIndicator").html(defaultFontSize),$("#fontMinusBtn").on("click",function(){$.fn.adjustFontSize("minus")}),$("#fontPlusBtn").on("click",function(){$.fn.adjustFontSize("plus")})),$.fn.loadSlide(topicSrc[0],counter),$.fn.loadProfilePhoto(),$("#player").show()},$.fn.loadSlide=function(e,t){var i,a=e.substring(e.indexOf(":")+1);if("quiz"!==e&&(e=e.substring(0,e.indexOf(":")+1)),$("#slide").html('<div id="progressing"></div>'),videoPlaying&&($("#vp").html(""),$("#vp").hide(),videoPlaying=!1),audioPlaying){try{audioPlayer.pause()}catch(r){}enabledNote?($("#ap").hide(),$("#note").hasClass("cropped")&&$("#note").removeClass("cropped")):$("#apm").hide(),audioPlaying=!1}switch(e){case"image:":i=new Image,imgPath="assets/slides/"+a+"."+slideImgFormat,imgCaption=$("#selectable li .title").get(t).innerHTML,$(i).load(function(){$(this).hide(),$("#slide").append('<a id="img" title="'+imgCaption+'" href="'+imgPath+'">'),$("#slide #img").html(i),$("#slide").append('</a><div class="magnifyIcon"></div>'),$(this).fadeIn(),$(this).bindImgMagnify()}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,border:0});break;case"image-audio:":i=new Image,imgPath="assets/slides/"+a+"."+slideImgFormat,imgCaption=$("#selectable li .title").get(t).innerHTML,$(i).load(function(){$(this).hide(),$("#slide").append('<a id="img" title="'+imgCaption+'"href="'+imgPath+'">'),$("#slide #img").html(i),$("#slide").append('</a><div class="magnifyIcon"></div>'),$(this).fadeIn(),$(this).bindImgMagnify(),audioPlaying||(enabledNote?$.fn.fileExists("assets/audio/"+a,"mp3","audio/mpeg")?($("#ap").show(),firstAudioLoad!==!0?($.fn.loadAudioPlayer("#apc",a),firstAudioLoad=!0):(sources=[{src:"assets/audio/"+a+".mp3",type:"audio/mpeg"}],audioPlayer.setSrc(sources)),$("#note").addClass("cropped")):($("#note").hasClass("cropped")&&$("#note").removeClass("cropped"),$.fn.displayErrorMsg("audio file not found!","Expected file: assets/audio/"+a+".mp3")):$.fn.fileExists("assets/audio/"+a,"mp3","audio/mpeg")?($("#apm").show(),firstAudioLoad!==!0?($.fn.loadAudioPlayer("#apcm",a),firstAudioLoad=!0):(sources=[{src:"assets/audio/"+a+".mp3",type:"audio/mpeg"}],audioPlayer.setSrc(sources))):$.fn.displayErrorMsg("audio file not found!","Expected file: assets/audio/"+a+".mp3"),audioPlaying=!0)}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,border:0});break;case"video:":var n=$.now(),o="vpc"+n;$("#vp").append('<video id="'+o+'" class="video-js vjs-default-skin" controls autoplay width="640" height="360">'+($.fn.fileExists("assets/video/"+a,"vtt","text/vtt")?'<track kind="subtitles" src="assets/video/'+a+'.vtt" srclang="en" label="English" default>':"")+"</video>"),videoPlaying||($("#vp").show(),videojs(o,{},function(){this.progressTips(),this.src([{type:"video/mp4",src:"assets/video/"+a+".mp4"},{type:"video/webm",src:"assets/video/"+a+".webm"}])}),videojs.options.flash.swf="sources/videoplayer/video-js.swf",videoPlaying=!0);break;case"youtube:":$("#slide").append('<iframe width="640" height="360" src="https://www.youtube.com/embed/'+a+'?modestbranding=1&theme=light&color=white&showinfo=0&autoplay=1&controls=2&html5=1&autohide=1&rel=0" frameborder="0" allowfullscreen></iframe>');break;case"swf:":$("#slide").append('<object width="640" height="360" type="application/x-shockwave-flash" data="assets/swf/'+a+'.swf"><param name="movie" value="assets/swf/'+a+'.swf" /><div id="errorMsg"><p>Error: Adobe Flash Player is not enabled or installed!</p><p>Adobe Flash Player is required to view this slide. Please enable or <a href="http://get.adobe.com/flashplayer/" target="_blank">install Adobe Flash Player</a>.</p></div></object>');break;case"quiz":$.fn.setupQuiz(t);break;default:$.fn.displayErrorMsg("unknow slide type!","Please double check the XML file.")}$("#progressing").hide(),enabledNote&&$(this).loadNote(t),$(this).updateSlideNum(t)},$.fn.setupQuiz=function(e){for(;!found||qNum===quizArray.length;)quizArray[qNum].id===e?found=!0:qNum++;if($("#slide").append('<div id="quiz"><div class="header">Quiz '+(qNum+1)+" of "+quizArray.length+"</div>"),$("#quiz").hide(),$("#quiz").fadeIn(),quizArray[qNum].taken)$.fn.showFeedback(qNum);else{if($("#quiz").append('<div class="question">'+quizArray[qNum].question+"</div>"),"t/f"===quizArray[qNum].type)$("#quiz").append('<div class="answerArea"><label for="t"><input id="t" type="radio" name="tf" value="true" /> True</label><label for="f"><input type="radio" id="f" name="tf" value="false" /> False</label></div>');else if("fib"===quizArray[qNum].type)$("#quiz").append('<div class="answerArea"><textarea id="saAns"></textArea></div>');else if("mc"===quizArray[qNum].type){$("#quiz").append('<div class="answerArea">');for(var t=0;t<quizArray[qNum].choice.length;t++)$(".answerArea").append('<label for="'+t+'"><input id="'+t+'" type="radio" name="mc" value="'+quizArray[qNum].choice[t]+'" /> '+quizArray[qNum].choice[t]+"</label>");$("#quiz").append("</div>")}else $("#quiz").append("sa"===quizArray[qNum].type?'<div class="answerArea"><textarea id="saAns"></textArea></div>':'<div class="answerArea">ERROR!</div>');$("#quiz").append('<div class="submitArea"><a id="check" rel="'+qNum+'" href="javascript:void(0)">SUBMIT</a></div>'),$("#check").click(function(){var e=Number($(this).attr("rel")),t;if("t/f"===quizArray[e].type?(t=$("input:radio[name=tf]:checked").val(),void 0===t&&(t="")):"fib"===quizArray[e].type?t=$.trim($("#saAns").val()):"mc"===quizArray[e].type?(t=$("input:radio[name=mc]:checked").val(),quizArray[e].incorrectIndex=$("input:radio[name=mc]").index($("input:radio[name=mc]").filter(":checked")),void 0===t&&(t="")):"sa"===quizArray[e].type?t=$.trim($("#saAns").val()):$.trim(t),""!==t){for(var i=0;i<quizArray[e].answer.length;i++)if("fib"===quizArray[e].type){var a=0;for(a;a<quizArray[e].answer.length;a++)if(t.toLowerCase()===quizArray[e].answer[a].toLowerCase()){quizArray[e].correct=!0;break}}else"t/f"===quizArray[e].type?quizArray[e].correct=t.toLowerCase()===quizArray[e].answer[i].toLowerCase()?!0:!1:"mc"===quizArray[e].type&&(quizArray[e].correct=t.toLowerCase()===quizArray[e].answer[i].toLowerCase()?!0:!1);quizArray[e].stuAnswer=t,quizArray[e].taken=!0,$.fn.showFeedback(e)}else alert("Please answer the question before submitting.")})}$("#slide").append("</div>"),qNum=0,found=!1},$.fn.showFeedback=function(e){var t="";$("#slide").html('<div id="quiz"><div class="header">Quiz '+(e+1)+" of "+quizArray.length+" Feedback</div>"),"sa"!==quizArray[e].type&&$("#quiz").append(quizArray[e].correct?'<p class="quizCorrect"><span class="icon-checkmark"></span> CORRECT</p>':'<p class="quizIncorrect"><span class="icon-notification"></span> INCORRECT</p>'),$("#quiz").append('<div class="question">'+quizArray[e].question+"</div>"),$("#quiz").append('<div class="feedback"><p><strong>Your answer</strong>: '+quizArray[e].stuAnswer+"</p>");for(var i=0;i<quizArray[e].answer.length;i++)t+=i===quizArray[e].answer.length-1?quizArray[e].answer[i]:quizArray[e].answer[i]+", ";if($(".feedback").append("<p><strong>Correct answer</strong>: "+t+"</p></div>"),"sa"!==quizArray[e].type)if(quizArray[e].correct)$(".feedback").append("<p><strong>Feedback:</strong> "+quizArray[e].correctFeedback+"</p>");else if("mc"===quizArray[e].type){var a=quizArray[e].wrongFeedback[quizArray[e].incorrectIndex];"undefined"==typeof a&&(a=""),$(".feedback").append("<p><strong>Feedback:</strong> "+a+"</p>")}else $(".feedback").append("<p><strong>Feedback:</strong> "+quizArray[e].wrongFeedback+"</p>")},$.fn.loadAudioPlayer=function(e,t){var i=640,a=30;"#apcm"===e&&(i=300,a=0),audioPlayer=new MediaElementPlayer(e,{audioWidth:i,audioHeight:a,startVolume:.8,loop:!1,enableAutosize:!0,iPadUseNativeControls:!1,iPhoneUseNativeControls:!1,AndroidUseNativeControls:!1,pauseOtherPlayers:!0,type:"audio/mpeg",success:function(e){sources=[{src:"assets/audio/"+t+".mp3",type:"audio/mpeg"}],e.setSrc(sources),e.load()}})},$.fn.loadNote=function(e){var t=noteArray[e];$("#note").html(t).hide().fadeIn("fast"),$("#note").find("a").length&&$("#note a").each(function(){$(this).attr("target","_blank")})},$.fn.updateSlideNum=function(e){var t=e+1;counter=e,$("#selectable li").each(function(){$(this).removeClass("ui-selected")}),$("#selectable li:nth-child("+t+")").addClass("ui-selected"),$("#currentStatus").html(media+" "+t+" of "+topicCount)},$.fn.bindImgMagnify=function(){$(".magnifyIcon").on("click",function(){$.fancybox.open({href:imgPath,title:imgCaption,helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0})}),$("a#img").fancybox({helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0})},$.fn.loadProfilePhoto=function(){var e=new Image,t="assets/pic.jpg";$(e).load(function(){$("#profile .photo").html('<img src="'+t+'" alt="Instructor Photo" border="0" />')}).error(function(){$("#profile .photo").html('<img src="https://mediastreamer.doit.wisc.edu/uwli-ltc/media/storybook_plus/img/profile.png" width="200" height="300" alt="No Profile Photo" border="0" />')}).attr({src:t,border:0})},$.fn.adjustFontSize=function(e){var t=2;"minus"===e?defaultFontSize-=t:"plus"===e&&(defaultFontSize+=t),12>=defaultFontSize?defaultFontSize=12:defaultFontSize>=20&&(defaultFontSize=20),$("#note").removeClass(),12===defaultFontSize?$("#note").addClass("size12"):16===defaultFontSize?$("#note").addClass("size16"):18===defaultFontSize?$("#note").addClass("size18"):20===defaultFontSize&&$("#note").addClass("size20"),$("#fontSizeIndicator").html(defaultFontSize)},$.fn.getDownloadableFile=function(e,t,i){var a=e,r="Audio",n=$("#download_bar ul"),o=window.location.protocol;if("http:"!==o){var s=window.location.href;s=s.substr(0,s.lastIndexOf("/")+1).replace("https","http"),a=s+e}"pdf"===t&&(r="Transcript"),$.fn.fileExists(e,t,i)&&n.append('<li><a href="'+a+"."+t+'" target="_blank"><span class="icon-arrow-down"><span> '+r+"</a></li>")},$.fn.displayGetLessonError=function(e,t){var i,a;switch(e){case 0:i="<strong>Error 0</strong> - Not connect. Please verify network.";break;case 404:i="<strong>Error 404</strong> - Requested page not found.";break;case 406:i="<strong>Error 406</strong> - Not acceptable error.";break;case 500:i="<strong>Error 500</strong> - Internal Server Error.";break;default:i="Unknow error ... "+e}switch(t){case"parsererror":a="Invalid XML. XML parse failed.";break;case"timeout":a="XML parsing timed out.";break;case"abort":a="Ajax request aborted.";break;case"error":a="Failed to get requested source. Most likely a 404 or 406.";break;default:a="Uncaught Error ... "+e.responseText}$("#splash_screen, #player").hide(),$("#errorMsg").html("<p>"+i+"<br />"+a+"</p>")},$.fn.splitSelections=function(e){var t=e.split("|");return t},$.fn.displayErrorMsg=function(e,t){$("#slide").html('<div id="errorMsg"><p><strong>Error:</strong> '+e+"</p><p>"+t+"</p></div>")},$.fn.getDirectory=function(){var e=window.location.href,t;return t=e.split("?"),t=t[0].split("/"),t=t[t.length-2]},$.fn.fileExists=function(e,t,i){var a,r=i;switch(t){case"pdf":r="application/pdf"}return $.ajax({url:e+"."+t,type:"HEAD",dataType:"text",contentType:r,async:!1,beforeSend:function(e){e.overrideMimeType(r),e.setRequestHeader("Accept",r)},success:function(){a=!0},error:function(){a=!1}}),a},$.fn.getParameterByName=function(e){var t="[\\?&]"+e+"=([^&#]*)",i=new RegExp(t),a=i.exec(window.location.href);return e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},$.fn.addLeadingZero=function(e){return 10>e?"0"+e:e};
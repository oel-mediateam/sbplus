var defaultFontSize=14,topicCount=0,counter=0,previousIndex=0,tocIndex=0,noteArray,topicSrc,topicTitle,imgPath,slideImgFormat="png",media="Slide",enabledNote=!1,imgCaption,questions,quizDetected=!1,PROFILE,lessonTitle,instructor,duration,audioPlayer,firstAudioLoad=!1,audioPlaying=!1,videoPlaying=!1,sources;$(document).ready(function(){var e=navigator.userAgent,t={ios:e.match(/(iPhone|iPod|iPad)/i),android:e.match(/Android/i),blackberry:e.match(/BlackBerry/i)},i="0"===$.fn.getParameterByName("m")?!1:!0;if((t.ios||t.blackberry||t.android)&&i){var s=window.location.href,n;return n=s.substr(s.indexOf(".")),s="http://mediastreamer"+n+"?m=0",$("body").html('<div class="mobile"><a href="'+s+'" target="_blank"><img src="https://mediastreamer.doit.wisc.edu/uwli-ltc/media/storybook_plus/img/view_on_full_site.png" width="450px" height="315px" alt="Launch Presentation in New Window" border="0" /></a></div>'),!1}$.fn.getLessonContent("assets/topic.xml")}),$.fn.getLessonContent=function(e){$.ajaxSetup({url:e,type:"GET",dataType:"xml",accepts:"xml",content:"xml",contentType:'xml; charset="utf-8"',cache:!1}),$.ajax({encoding:"UTF-8",beforeSend:function(e){e.overrideMimeType("xml; charset=utf-8"),e.setRequestHeader("Accept","text/xml")},success:function(e){$.fn.parseContent(e)},error:function(e,t){$.fn.displayGetLessonError(e.status,t)}})},$.fn.parseContent=function(e){var t=$(e),i=t.find("setup"),s=t.find("topic"),n=$.fn.stripScript(i.find("lesson").text()),o=$.trim(i.find("instructor").text()),a=$.fn.stripScript(i.find("length").text()),r=$.fn.stripScript(i.find("note").text()),d=$.fn.stripScript(i.find("slideImgFormat").text());PROFILE=$.fn.stripScript(t.find("profile").text()),lessonTitle="Lesson name is not specified.",instructor="Instructor name is not specified.",duration="",n.length&&(lessonTitle=n),o.length&&(instructor=o),a.length&&(duration=a),r.length&&("yes"===r||"y"===r)&&(enabledNote=!0),d.length&&(slideImgFormat=d),topicSrc=[],topicTitle=[],noteArray=[],questions=[],s.each(function(){if(topicTitle[topicCount]=$.trim($(this).attr("title")),topicSrc[topicCount]=$.trim($(this).attr("src")),enabledNote&&(noteArray[topicCount]=$.fn.stripScript($(this).find("note").text())),"quiz"===topicSrc[topicCount]){var e=$.fn.stripScript(t.find("topic:eq("+topicCount+")").find("quiz").find("question").text()),i=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("question").attr("img")),s=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("question").attr("audio")),n=$.fn.stripScript(t.find("topic:eq("+topicCount+")").find("quiz").find("choice").text()),o=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("choice").attr("useImg")),a=$.fn.stripScript(t.find("topic:eq("+topicCount+")").find("quiz").find("wrongFeedback").text()),r=$.fn.stripScript(t.find("topic:eq("+topicCount+")").find("quiz").find("correctFeedback").text()),d=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").attr("type")),c=$.fn.stripScript(t.find("topic:eq("+topicCount+")").find("quiz").find("answer").text()),l={};quizDetected=!0,l.id=topicCount,l.type=d,l.question=e,l.img=""!==i?i:"",l.audio=""!==s?s:"",l.choiceImg=""!==o?o:"",n?(l.choice=$.fn.splitSelections(n),l.wrongFeedback=$.fn.splitSelections(a)):l.wrongFeedback=a,l.answer=$.fn.splitSelections(c),l.stuAnswer="",l.correct=!1,l.correctFeedback=r,l.taken=!1,questions.push(l)}++topicCount}),$.fn.setupPlayer()},$.fn.setupPlayer=function(){var e=$.fn.getDirectory(),t;$(document).attr("title",lessonTitle),$("#errorMsg").hide(),$.each(topicSrc,function(e){var t=topicSrc[e].substring(0,topicSrc[e].indexOf(":")+1);return"video:"!==t&&"youtube:"!==t?(media="Slide",!1):void(media="Video")}),enabledNote===!1&&quizDetected===!1?$("#storybook_plus_wrapper").addClass("noteDisabled"):enabledNote===!1&&quizDetected===!0&&($("#storybook_plus_wrapper").addClass("withQuiz"),$("#note").html('<div class="noNotes">NOTES DISABLED</div>')),$.each(topicTitle,function(e){t="quiz"===topicSrc[e]?' <span class="icon-assessement light"></span>':"",$("#selectable").append('<li class="ui-widget-content" title="'+topicTitle[e]+'"><div class="slideNum">'+$.fn.addLeadingZero(e+1)+'.</div><div class="title">'+topicTitle[e]+t+"</div></li>")}),$("#splash_screen").css("background-image","url(assets/splash.jpg)"),$("#splash_screen").append("<p>"+lessonTitle+"</p><p>"+instructor+"</p>"+(0!==duration?"<p><small>"+duration+"</small></p>":"")+'<a class="playBtn" href="#"></a>'),$("#splash_screen, #playBtn").on("click",function(){return $.fn.initializePlayer(),!1}),$.fn.getDownloadableFile(e,"mp3","audio/mpeg"),$.fn.getDownloadableFile(e,"pdf","application/pdf")},$.fn.initializePlayer=function(){$("#splash_screen").hide(),$("#lessonTitle").html(lessonTitle),$("#instructorName").html('<a class="instructorName" href="#profile">'+instructor+"</a>"),$("#profile .bio").html("<p>"+instructor+"</p>"+PROFILE),$("#player").append('<div id="progressing"></div>'),$("#info, a.instructorName").fancybox({helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0}),$("#selectable li:first").addClass("ui-selected"),$("#selectable").selectable({stop:function(){$(".ui-selected",this).each(function(){tocIndex=$("#selectable li").index(this)}),tocIndex!==previousIndex&&($.fn.loadSlide(topicSrc[tocIndex],tocIndex),previousIndex=tocIndex)}}),$("#leftBtn").on("click",function(){return counter--,0>counter&&(counter=topicCount-1),$.fn.loadSlide(topicSrc[counter],counter),previousIndex=counter,!1}),$("#rightBtn").on("click",function(){return counter++,counter>topicCount-1&&(counter=0),$.fn.loadSlide(topicSrc[counter],counter),previousIndex=counter,!1}),enabledNote&&($("#fontSizeIndicator").html(defaultFontSize),$("#fontMinusBtn").on("click",function(){return $.fn.adjustFontSize("minus"),!1}),$("#fontPlusBtn").on("click",function(){return $.fn.adjustFontSize("plus"),!1})),$.fn.loadSlide(topicSrc[0],counter),$.fn.loadProfilePhoto(),$("#player").show()},$.fn.loadSlide=function(e,t){var i,s=e.substring(e.indexOf(":")+1);if("quiz"!==e&&(e=e.substring(0,e.indexOf(":")+1)),$("#progressing").fadeIn(),$("#slideNote").hasClass("quizSlide")&&$("#slideNote").removeClass("quizSlide"),videoPlaying&&($("#vp").html(""),$("#vp").hide(),videoPlaying=!1),audioPlaying){try{audioPlayer.pause()}catch(n){}enabledNote===!1&&quizDetected===!1?$("#apm").hide():($("#ap").hide(),$("#note").hasClass("cropped")&&$("#note").removeClass("cropped")),audioPlaying=!1}switch(e){case"image:":i=new Image,imgPath="assets/slides/"+s+"."+slideImgFormat,imgCaption=$("#selectable li .title").get(t).innerHTML,$(i).load(function(){$(this).hide(),$("#slide").html('<a id="img" title="'+imgCaption+'" href="'+imgPath+'">'),$("#slide #img").html(i),$("#slide").append('</a><div class="magnifyIcon"></div>'),$(this).fadeIn(),$(this).bindImgMagnify(),$("#progressing").fadeOut()}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,border:0});break;case"image-audio:":i=new Image,imgPath="assets/slides/"+s+"."+slideImgFormat,imgCaption=$("#selectable li .title").get(t).innerHTML,$(i).load(function(){$(this).hide(),$("#slide").html('<a id="img" title="'+imgCaption+'"href="'+imgPath+'">'),$("#slide #img").html(i),$("#slide").append('</a><div class="magnifyIcon"></div>'),$(this).fadeIn(),$(this).bindImgMagnify(),$("#progressing").fadeOut(),audioPlaying||(enabledNote===!1&&quizDetected===!1?$.fn.fileExists("assets/audio/"+s,"mp3","audio/mpeg")?($("#apm").show(),firstAudioLoad!==!0?($.fn.loadAudioPlayer("#apcm",s),firstAudioLoad=!0):(sources=[{src:"assets/audio/"+s+".mp3",type:"audio/mpeg"}],audioPlayer.setSrc(sources))):$.fn.displayErrorMsg("audio file not found!","Expected file: assets/audio/"+s+".mp3"):$.fn.fileExists("assets/audio/"+s,"mp3","audio/mpeg")?($("#ap").show(),firstAudioLoad!==!0?($.fn.loadAudioPlayer("#apc",s),firstAudioLoad=!0):(sources=[{src:"assets/audio/"+s+".mp3",type:"audio/mpeg"}],audioPlayer.setSrc(sources)),$("#note").addClass("cropped")):($("#note").hasClass("cropped")&&$("#note").removeClass("cropped"),$.fn.displayErrorMsg("audio file not found!","Expected file: assets/audio/"+s+".mp3")),audioPlaying=!0)}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,border:0});break;case"video:":var o=$.now(),a="vpc"+o;$("#vp").append('<video id="'+a+'" class="video-js vjs-default-skin" controls autoplay width="640" height="360">'+($.fn.fileExists("assets/video/"+s,"vtt","text/vtt")?'<track kind="subtitles" src="assets/video/'+s+'.vtt" srclang="en" label="English" default>':"")+"</video>").promise().done(function(){$("#progressing").fadeOut()}),videoPlaying||($("#vp").show(),videojs(a,{},function(){this.progressTips(),this.src([{type:"video/mp4",src:"assets/video/"+s+".mp4"},{type:"video/webm",src:"assets/video/"+s+".webm"}])}),videojs.options.flash.swf="sources/videoplayer/video-js.swf",videoPlaying=!0);break;case"youtube:":$("#slide").html('<iframe width="640" height="360" src="https://www.youtube.com/embed/'+s+'?modestbranding=1&theme=light&color=white&showinfo=0&autoplay=1&controls=2&html5=1&autohide=1&rel=0" frameborder="0" allowfullscreen></iframe>').promise().done(function(){$("#progressing").fadeOut()});break;case"swf:":$("#slide").html('<object width="640" height="360" type="application/x-shockwave-flash" data="assets/swf/'+s+'.swf"><param name="movie" value="assets/swf/'+s+'.swf" /><div id="errorMsg"><p>Error: Adobe Flash Player is not enabled or installed!</p><p>Adobe Flash Player is required to view this slide. Please enable or <a href="http://get.adobe.com/flashplayer/" target="_blank">install Adobe Flash Player</a>.</p></div></object>').promise().done(function(){$("#progressing").fadeOut()});break;case"quiz":$("#slideNote").addClass("quizSlide"),$.fn.setupQuiz(t),$("#progressing").fadeOut();break;default:$.fn.displayErrorMsg("unknow slide type!","Please double check the XML file.")}enabledNote&&$(this).loadNote(t),$(this).updateSlideNum(t)},$.fn.setupQuiz=function(e){for(var t=0,i=!1;!i||t>=questions.length;)questions[t].id===e?i=!0:t++;if($("#slide").html('<div id="quiz"><div class="header"><span class="icon-assessement"></span> Self-Assessment</div>'),questions[t].taken)$.fn.showFeedback(t);else if(""!==questions[t].img){var s=new Image;imgPath="assets/img/"+questions[t].img,$(s).load(function(){$("#quiz").append('<div class="question">'+questions[t].question+"</div>"),$(".question").append(s);var e="";""!==questions[t].audio&&(e='<audio controls autoplay><source src="assets/audio/'+questions[t].audio+'" type="audio/mpeg" /></audio>',$("#quiz").append(e)),$.fn.displayAnswerChoices(t)}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,alt:questions[t].question,border:0})}else{var n="";""!==questions[t].audio&&(n='<audio controls autoplay><source src="assets/audio/'+questions[t].audio+'" type="audio/mpeg" /></audio>'),$("#quiz").append('<div class="question">'+questions[t].question+n+"</div>"),$.fn.displayAnswerChoices(t)}},$.fn.displayAnswerChoices=function(e){var t,i=!1;switch(questions[e].type){case"t/f":$("#quiz").append('<div class="answerArea"><label for="t"><input id="t" type="radio" name="tf" value="true" /> True</label><label for="f"><input type="radio" id="f" name="tf" value="false" /> False</label></div>');break;case"fib":$("#quiz").append('<div class="answerArea"><input type="text" id="saAns" /></div>');break;case"mc":var s="radio",n="mc";if(t=questions[e].answer.length,$("#quiz").append('<div class="answerArea">'),t>1&&(s="checkbox",n="ma"),"true"===questions[e].choiceImg)for(var o=0;o<questions[e].choice.length;o++)$(".answerArea").append('<label class="img_choice"for="'+o+'"><input id="'+o+'" type="'+s+'" name="'+n+'" value="'+questions[e].choice[o]+'" /> <img src="assets/img/'+questions[e].choice[o]+'" /></label>');else for(var a=0;a<questions[e].choice.length;a++)$(".answerArea").append('<label for="'+a+'"><input id="'+a+'" type="'+s+'" name="'+n+'" value="'+questions[e].choice[a]+'" /> '+questions[e].choice[a]+"</label>");$("#quiz").append("</div>");break;case"sa":$("#quiz").append('<div class="answerArea"><textarea id="saAns"></textArea></div>');break;default:i=!0,$.fn.displayErrorMsg("unknow question type!","Please double check the topic XML file.")}i||($("#quiz").append('<div class="submitArea"><a id="check" rel="'+e+'" href="javascript:void(0)">SUBMIT</a></div>'),$("#slide").append("</div>"),$("#quiz").hide().fadeIn(),$("#check").on("click",function(){var e=Number($(this).attr("rel")),i;switch(questions[e].type){case"t/f":i=$("input:radio[name=tf]:checked").val(),void 0===i&&(i="");break;case"fib":i=$.trim($("#saAns").val());break;case"mc":t>1?(i=[],$("input:checkbox[name=ma]:checked").each(function(){i.push($(this).val())}),questions[e].incorrectIndex=0):(i=$("input:radio[name=mc]:checked").val(),questions[e].incorrectIndex=$("input:radio[name=mc]").index($("input:radio[name=mc]").filter(":checked"))),(void 0===i||i.length<=0)&&(i="");break;case"sa":i=$.trim($("#saAns").val());break;default:i=""}if(""!==i){switch(questions[e].type){case"fib":for(var s=0;s<questions[e].answer.length;s++)if(i.toLowerCase()===questions[e].answer[s].toLowerCase()){questions[e].correct=!0;break}break;case"t/f":questions[e].correct=i===String(questions[e].answer)?!0:!1;break;case"mc":var n=0;if(t>1){for(n=0;n<i.length;n++){if(!($.inArray(i[n],questions[e].answer)>=0)){questions[e].correct=!1;break}questions[e].correct=!0}n<questions[e].answer.length&&(questions[e].correct=!1)}else questions[e].correct=i===questions[e].answer[0]?!0:!1;break;default:questions[e].correct=!1}questions[e].stuAnswer=i,questions[e].taken=!0,$.fn.showFeedback(e)}else $(".question").before('<p class="quizIncorrect"><span class="icon-notification"></span> Please answer the question before submitting!</p>'),$(".quizIncorrect").delay(6e3).slideUp("slow",function(){$(".question").prev().remove()})}))},$.fn.showFeedback=function(e){var t="",i="";if($("#slide").html('<div id="quiz"><div class="header"><span class="icon-assessement"></span> Self-Assessment Feedback</div>'),"sa"!==questions[e].type&&$("#quiz").append(questions[e].correct?'<p class="quizCorrect"><span class="icon-checkmark"></span> CORRECT</p>':'<p class="quizIncorrect"><span class="icon-notification"></span> INCORRECT</p>'),""!==questions[e].img&&(t='<img src="assets/img/'+questions[e].img+'" alt="'+questions[e].question+'" border="0" />'),""!==questions[e].audio&&(i='<audio controls><source src="assets/audio/'+questions[e].audio+'" type="audio/mpeg" /></audio>'),$("#quiz").append('<div class="question">'+questions[e].question+t+i+"</div>"),"true"===questions[e].choiceImg?($("#quiz").append('<div class="result"><p><strong>Your answer</strong>:<br />'+$.fn.parseArrayImg(questions[e].stuAnswer)+"</p></div>"),$(".result").append("<p><strong>Correct answer</strong>:<br />"+$.fn.parseArrayImg(questions[e].answer)+"</p>")):($("#quiz").append('<div class="result"><p><strong>Your answer</strong>: '+$.fn.parseArray(questions[e].stuAnswer)+"</p></div>"),$(".result").append("<p><strong>Correct answer</strong>: "+$.fn.parseArray(questions[e].answer)+"</p>")),"sa"!==questions[e].type)if(questions[e].correct)""!==String(questions[e].correctFeedback)&&$(".result").append("<p><strong>Feedback:</strong> "+questions[e].correctFeedback+"</p>");else if("mc"===questions[e].type){var s=questions[e].wrongFeedback[questions[e].incorrectIndex];void 0===s&&(s=questions[e].wrongFeedback),""!==String(s)&&$(".result").append("<p><strong>Feedback:</strong> "+s+"</p>")}else""!==String(questions[e].wrongFeedback)&&$(".result").append("<p><strong>Feedback:</strong> "+questions[e].wrongFeedback+"</p>")},$.fn.loadAudioPlayer=function(e,t){var i=640,s=30;"#apcm"===e&&(i=300,s=0),audioPlayer=new MediaElementPlayer(e,{audioWidth:i,audioHeight:s,startVolume:.8,loop:!1,enableAutosize:!0,iPadUseNativeControls:!1,iPhoneUseNativeControls:!1,AndroidUseNativeControls:!1,pauseOtherPlayers:!0,type:"audio/mpeg",success:function(e){sources=[{src:"assets/audio/"+t+".mp3",type:"audio/mpeg"}],e.setSrc(sources),e.load()}})},$.fn.loadNote=function(e){var t=noteArray[e];$("#slideNote").hasClass("quizSlide")?$("#note").hide():$("#note").html(t).hide().fadeIn("fast"),$("#note").find("a").length&&$("#note a").each(function(){$(this).attr("target","_blank")})},$.fn.updateSlideNum=function(e){var t=e+1;counter=e,$("#selectable li").each(function(){$(this).removeClass("ui-selected")}),$("#selectable li:nth-child("+t+")").addClass("ui-selected"),$("#currentStatus").html(media+" "+t+" of "+topicCount)},$.fn.bindImgMagnify=function(){$(".magnifyIcon").on("click",function(){$.fancybox.open({href:imgPath,title:imgCaption,helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0})}),$("a#img").fancybox({helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0})},$.fn.loadProfilePhoto=function(){var e=new Image,t="assets/pic.jpg";$(e).load(function(){$("#profile .photo").html('<img src="'+t+'" alt="Instructor Photo" border="0" />')}).error(function(){$("#profile .photo").html('<img src="https://mediastreamer.doit.wisc.edu/uwli-ltc/media/storybook_plus/img/profile.png" width="200" height="300" alt="No Profile Photo" border="0" />')}).attr({src:t,border:0})},$.fn.adjustFontSize=function(e){var t=2;"minus"===e?defaultFontSize-=t:"plus"===e&&(defaultFontSize+=t),12>=defaultFontSize?defaultFontSize=12:defaultFontSize>=20&&(defaultFontSize=20),$("#note").removeClass(),12===defaultFontSize?$("#note").addClass("size12"):16===defaultFontSize?$("#note").addClass("size16"):18===defaultFontSize?$("#note").addClass("size18"):20===defaultFontSize&&$("#note").addClass("size20"),$("#fontSizeIndicator").html(defaultFontSize)},$.fn.getDownloadableFile=function(e,t,i){var s=e,n="Audio",o=$("#download_bar ul"),a=window.location.protocol;if("http:"!==a){var r=window.location.href;r=r.substr(0,r.lastIndexOf("/")+1).replace("https","http"),s=r+e}"pdf"===t&&(n="Transcript"),$.fn.fileExists(e,t,i)&&o.append('<li><a href="'+s+"."+t+'" target="_blank"><span class="icon-arrow-down"><span> '+n+"</a></li>")},$.fn.displayGetLessonError=function(e,t){var i,s;switch(e){case 0:i="<strong>Error 0</strong> - Not connect. Please verify network.";break;case 200:i="<strong>Error 200</strong> - Invalid characters in XML.";break;case 404:i="<strong>Error 404</strong> - Requested page not found.";break;case 406:i="<strong>Error 406</strong> - Not acceptable error.";break;case 500:i="<strong>Error 500</strong> - Internal Server Error.";break;default:i="Unknow error ... "+e}switch(t){case"parsererror":s="XML parse failed. Please double-check the <strong>topic.xml</strong> file in the <strong>assets</strong> directory. All node values must be wrapped inside <code>&lt;![CDATA[ ... ]]&gt;</code> or use HTML entity for special characters.";break;case"timeout":s="XML parsing timed out. It is taking too long for the browser.";break;case"abort":s="Ajax request aborted.";break;case"error":s="Failed to get requested source. Most likely a 404 or 406.";break;default:s="Uncaught Error ... "+e.responseText}$("#splash_screen, #player").hide(),$("#errorMsg").html("<p>"+i+"</p><p>"+s+"</p>")},$.fn.splitSelections=function(e){var t=e.split("|");return t},$.fn.displayErrorMsg=function(e,t){$("#slide").html('<div id="errorMsg"><p><strong>Error:</strong> '+e+"</p><p>"+t+"</p></div>")},$.fn.getDirectory=function(){var e=window.location.href,t;return t=e.split("?"),t=t[0].split("/"),t=t[t.length-2]},$.fn.fileExists=function(e,t,i){var s,n=i;switch(t){case"pdf":n="application/pdf"}return $.ajax({url:e+"."+t,type:"HEAD",dataType:"text",contentType:n,async:!1,beforeSend:function(e){e.overrideMimeType(n),e.setRequestHeader("Accept",n)},success:function(){s=!0},error:function(){s=!1}}),s},$.fn.getParameterByName=function(e){var t="[\\?&]"+e+"=([^&#]*)",i=new RegExp(t),s=i.exec(window.location.href);return e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),null===s?"":decodeURIComponent(s[1].replace(/\+/g," "))},$.fn.addLeadingZero=function(e){return 10>e?"0"+e:e},$.fn.parseArray=function(e){var t="";if($.isArray(e))for(var i=0;i<e.length;i++)t+=1===e.length?e[0]:i===e.length-1?e[i]:e[i]+", ";else t=e;return t},$.fn.parseArrayImg=function(e){var t="";if($.isArray(e))for(var i=0;i<e.length;i++)t+='<img src="assets/img/'+e[i]+'" /> ';else t='<img src="assets/img/'+e+'" /> ';return t},$.fn.stripScript=function(e){if(""!==e||void 0!==e){var t=$("<span>"+$.trim(e)+"</span>");return t.find("script,noscript,style").remove().end(),t.html()}return e};
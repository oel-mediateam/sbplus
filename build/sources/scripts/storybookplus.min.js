var defaultFontSize=14,topicCount=0,counter=0,previousIndex=0,tocIndex=0,noteArray,topicSrc,topicTitle,imgPath,slideImgFormat="png",media="Slide",enabledNote=!1,imgCaption,questions,PROFILE,lessonTitle,instructor,duration,audioPlayer,firstAudioLoad=!1,audioPlaying=!1,videoPlaying=!1,sources;$(document).ready(function(){var e=navigator.userAgent,t={iphone:e.match(/(iPhone|iPod|iPad)/),blackberry:e.match(/BlackBerry/),android:e.match(/Android/)},i="0"===$.fn.getParameterByName("m")?!1:!0;if((t.iphone||t.ipod||t.ipad||t.blackberry||t.android)&&i){var n=window.location.href,s=n.indexOf("."),a;return a=n.substr(s),n="http://mediastreamer"+a+"?m=0",$("body").html('<div style="text-align:center; width:450px; height:315px;"><a href="'+n+'" target="_blank"><img src="https://mediastreamer.doit.wisc.edu/uwli-ltc/media/storybook_plus/img/view_on_full_site.png" width="450px" height="315px" alt="Launch Presentation in New Window" border="0" /></a></div>'),!1}$.fn.getLessonContent("assets/topic.xml")}),$.fn.getLessonContent=function(e){$.ajaxSetup({url:e,type:"GET",dataType:"xml",accepts:"xml",content:"xml",contentType:'xml; charset="utf-8"',cache:!1}),$.ajax({encoding:"UTF-8",beforeSend:function(e){e.overrideMimeType("xml; charset=utf-8"),e.setRequestHeader("Accept","text/xml")},success:function(e){$.fn.parseContent(e)},error:function(e,t){$.fn.displayGetLessonError(e.status,t)}})},$.fn.parseContent=function(e){var t=$(e),i=t.find("setup"),n=t.find("topic"),s=$.trim(i.find("lesson").text()),a=$.trim(i.find("instructor").text()),o=$.trim(i.find("length").text()),r=$.trim(i.find("note").text()),d=$.trim(i.find("slideImgFormat").text());PROFILE=$.trim(t.find("profile").text()),lessonTitle="Lesson name is not specified.",instructor="Instructor name is not specified.",duration="",s.length&&(lessonTitle=s),a.length&&(instructor=a),o.length&&(duration=o),r.length&&("yes"===r||"y"===r)&&(enabledNote=!0),d.length&&(slideImgFormat=d),topicSrc=[],topicTitle=[],noteArray=[],questions=[],n.each(function(){if(topicTitle[topicCount]=$(this).attr("title"),topicSrc[topicCount]=$(this).attr("src"),enabledNote&&(noteArray[topicCount]=$(this).find("note").text()),"quiz"===topicSrc[topicCount]){var e=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("question").text()),i=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("choice").text()),n=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("wrongFeedback").text()),s=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("correctFeedback").text()),a=t.find("topic:eq("+topicCount+")").find("quiz").attr("type"),o=$.trim(t.find("topic:eq("+topicCount+")").find("quiz").find("answer").text()),r={};r.id=topicCount,r.type=a,r.question=e,i?(r.choice=$.fn.splitSelections(i),r.wrongFeedback=$.fn.splitSelections(n)):r.wrongFeedback=n,r.answer=$.fn.splitSelections(o),r.stuAnswer="",r.correct=!1,r.correctFeedback=s,r.taken=!1,questions.push(r)}++topicCount}),$.fn.setupPlayer()},$.fn.setupPlayer=function(){var e=$.fn.getDirectory(),t;$(document).attr("title",lessonTitle),enabledNote||$("#storybook_plus_wrapper").addClass("noteDisabled"),$("#errorMsg").hide(),$.each(topicSrc,function(e){var t=topicSrc[e].substring(0,topicSrc[e].indexOf(":")+1);return"video:"!==t&&"youtube:"!==t?(media="Slide",!1):void(media="Video")}),$.each(topicTitle,function(e){t="quiz"===topicSrc[e]?' <span class="icon-assessement light"></span>':"",$("#selectable").append('<li class="ui-widget-content" title="'+topicTitle[e]+'"><div class="slideNum">'+$.fn.addLeadingZero(e+1)+'.</div><div class="title">'+topicTitle[e]+t+"</div></li>")}),$("#splash_screen").css("background-image","url(assets/splash.jpg)"),$("#splash_screen").append("<p>"+lessonTitle+"</p><p>"+instructor+"</p>"+(0!==duration?"<p><small>"+duration+"</small></p>":"")+'<a class="playBtn" href="#"></a>'),$("#splash_screen, #playBtn").on("click",function(){return $.fn.initializePlayer(),!1}),$.fn.getDownloadableFile(e,"mp3","audio/mpeg"),$.fn.getDownloadableFile(e,"pdf","application/pdf")},$.fn.initializePlayer=function(){$("#splash_screen").hide(),$("#lessonTitle").html(lessonTitle),$("#instructorName").html('<a class="instructorName" href="#profile">'+instructor+"</a>"),$("#profile .bio").html("<p>"+instructor+"</p>"+PROFILE),$("#info, a.instructorName").fancybox({helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0}),$("#selectable li:first").addClass("ui-selected"),$("#selectable").selectable({stop:function(){$(".ui-selected",this).each(function(){tocIndex=$("#selectable li").index(this)}),tocIndex!==previousIndex&&($.fn.loadSlide(topicSrc[tocIndex],tocIndex),previousIndex=tocIndex)}}),$("#leftBtn").on("click",function(){counter--,0>=counter&&(counter=topicCount),$.fn.loadSlide(topicSrc[counter],counter)}),$("#rightBtn").on("click",function(){counter++,counter>topicCount&&(counter=1),$.fn.loadSlide(topicSrc[counter],counter)}),enabledNote&&($("#fontSizeIndicator").html(defaultFontSize),$("#fontMinusBtn").on("click",function(){$.fn.adjustFontSize("minus")}),$("#fontPlusBtn").on("click",function(){$.fn.adjustFontSize("plus")})),$.fn.loadSlide(topicSrc[0],counter),$.fn.loadProfilePhoto(),$("#player").show()},$.fn.loadSlide=function(e,t){var i,n=e.substring(e.indexOf(":")+1);if("quiz"!==e&&(e=e.substring(0,e.indexOf(":")+1)),$("#slide").html('<div id="progressing"></div>'),videoPlaying&&($("#vp").html(""),$("#vp").hide(),videoPlaying=!1),audioPlaying){try{audioPlayer.pause()}catch(s){}enabledNote?($("#ap").hide(),$("#note").hasClass("cropped")&&$("#note").removeClass("cropped")):$("#apm").hide(),audioPlaying=!1}switch(e){case"image:":i=new Image,imgPath="assets/slides/"+n+"."+slideImgFormat,imgCaption=$("#selectable li .title").get(t).innerHTML,$(i).load(function(){$(this).hide(),$("#slide").append('<a id="img" title="'+imgCaption+'" href="'+imgPath+'">'),$("#slide #img").html(i),$("#slide").append('</a><div class="magnifyIcon"></div>'),$(this).fadeIn(),$(this).bindImgMagnify()}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,border:0});break;case"image-audio:":i=new Image,imgPath="assets/slides/"+n+"."+slideImgFormat,imgCaption=$("#selectable li .title").get(t).innerHTML,$(i).load(function(){$(this).hide(),$("#slide").append('<a id="img" title="'+imgCaption+'"href="'+imgPath+'">'),$("#slide #img").html(i),$("#slide").append('</a><div class="magnifyIcon"></div>'),$(this).fadeIn(),$(this).bindImgMagnify(),audioPlaying||(enabledNote?$.fn.fileExists("assets/audio/"+n,"mp3","audio/mpeg")?($("#ap").show(),firstAudioLoad!==!0?($.fn.loadAudioPlayer("#apc",n),firstAudioLoad=!0):(sources=[{src:"assets/audio/"+n+".mp3",type:"audio/mpeg"}],audioPlayer.setSrc(sources)),$("#note").addClass("cropped")):($("#note").hasClass("cropped")&&$("#note").removeClass("cropped"),$.fn.displayErrorMsg("audio file not found!","Expected file: assets/audio/"+n+".mp3")):$.fn.fileExists("assets/audio/"+n,"mp3","audio/mpeg")?($("#apm").show(),firstAudioLoad!==!0?($.fn.loadAudioPlayer("#apcm",n),firstAudioLoad=!0):(sources=[{src:"assets/audio/"+n+".mp3",type:"audio/mpeg"}],audioPlayer.setSrc(sources))):$.fn.displayErrorMsg("audio file not found!","Expected file: assets/audio/"+n+".mp3"),audioPlaying=!0)}).error(function(){$.fn.displayErrorMsg("image not found!","Expected image: "+imgPath)}).attr({src:imgPath,border:0});break;case"video:":var a=$.now(),o="vpc"+a;$("#vp").append('<video id="'+o+'" class="video-js vjs-default-skin" controls autoplay width="640" height="360">'+($.fn.fileExists("assets/video/"+n,"vtt","text/vtt")?'<track kind="subtitles" src="assets/video/'+n+'.vtt" srclang="en" label="English" default>':"")+"</video>"),videoPlaying||($("#vp").show(),videojs(o,{},function(){this.progressTips(),this.src([{type:"video/mp4",src:"assets/video/"+n+".mp4"},{type:"video/webm",src:"assets/video/"+n+".webm"}])}),videojs.options.flash.swf="sources/videoplayer/video-js.swf",videoPlaying=!0);break;case"youtube:":$("#slide").append('<iframe width="640" height="360" src="https://www.youtube.com/embed/'+n+'?modestbranding=1&theme=light&color=white&showinfo=0&autoplay=1&controls=2&html5=1&autohide=1&rel=0" frameborder="0" allowfullscreen></iframe>');break;case"swf:":$("#slide").append('<object width="640" height="360" type="application/x-shockwave-flash" data="assets/swf/'+n+'.swf"><param name="movie" value="assets/swf/'+n+'.swf" /><div id="errorMsg"><p>Error: Adobe Flash Player is not enabled or installed!</p><p>Adobe Flash Player is required to view this slide. Please enable or <a href="http://get.adobe.com/flashplayer/" target="_blank">install Adobe Flash Player</a>.</p></div></object>');break;case"quiz":$.fn.setupQuiz(t);break;default:$.fn.displayErrorMsg("unknow slide type!","Please double check the XML file.")}$("#progressing").hide(),enabledNote&&$(this).loadNote(t),$(this).updateSlideNum(t)},$.fn.setupQuiz=function(e){for(var t=0,i=!1,n=!1;!i||t>=questions.length;)questions[t].id===e?i=!0:t++;if($("#slide").append('<div id="quiz"><div class="header"><span class="icon-assessement"></span> Self-Assessment</div>'),questions[t].taken)$.fn.showFeedback(t);else{switch($("#quiz").append('<div class="question">'+questions[t].question+"</div>"),questions[t].type){case"t/f":$("#quiz").append('<div class="answerArea"><label for="t"><input id="t" type="radio" name="tf" value="true" /> True</label><label for="f"><input type="radio" id="f" name="tf" value="false" /> False</label></div>');break;case"fib":$("#quiz").append('<div class="answerArea"><input type="text" id="saAns" /></div>');break;case"mc":$("#quiz").append('<div class="answerArea">');for(var s=0;s<questions[t].choice.length;s++)$(".answerArea").append('<label for="'+s+'"><input id="'+s+'" type="radio" name="mc" value="'+questions[t].choice[s]+'" /> '+questions[t].choice[s]+"</label>");$("#quiz").append("</div>");break;case"sa":$("#quiz").append('<div class="answerArea"><textarea id="saAns"></textArea></div>');break;default:n=!0,$.fn.displayErrorMsg("unknow question type!","Please double check the topic XML file.")}n||$("#quiz").append('<div class="submitArea"><a id="check" rel="'+t+'" href="javascript:void(0)">SUBMIT</a></div>')}n||($("#slide").append("</div>"),$("#quiz").hide().fadeIn(),$("#check").on("click",function(){var e=Number($(this).attr("rel")),t;switch(questions[e].type){case"t/f":t=$("input:radio[name=tf]:checked").val(),void 0===t&&(t="");break;case"fib":t=$.trim($("#saAns").val());break;case"mc":t=$("input:radio[name=mc]:checked").val(),questions[e].incorrectIndex=$("input:radio[name=mc]").index($("input:radio[name=mc]").filter(":checked")),void 0===t&&(t="");break;case"sa":t=$.trim($("#saAns").val());break;default:t=""}if(""!==t){switch(questions[e].type){case"fib":for(var i=0;i<questions[e].answer.length;i++)if(t.toLowerCase()===questions[e].answer[i].toLowerCase()){questions[e].correct=!0;break}break;case"t/f":questions[e].correct=t===String(questions[e].answer)?!0:!1;break;case"mc":questions[e].correct=t===questions[e].answer[e]?!0:!1;break;default:questions[e].correct=!1}questions[e].stuAnswer=t,questions[e].taken=!0,$.fn.showFeedback(e)}else alert("Please answer the question before submitting.")}))},$.fn.showFeedback=function(e){var t="";$("#slide").html('<div id="quiz"><div class="header"><span class="icon-assessement"></span> Self-Assessment Feedback</div>'),"sa"!==questions[e].type&&$("#quiz").append(questions[e].correct?'<p class="quizCorrect"><span class="icon-checkmark"></span> CORRECT</p>':'<p class="quizIncorrect"><span class="icon-notification"></span> INCORRECT</p>'),$("#quiz").append('<div class="question">'+questions[e].question+'</div><div class="feedback"><p><strong>Your answer</strong>: '+questions[e].stuAnswer+"</p>");for(var i=0;i<questions[e].answer.length;i++)t+=i===questions[e].answer.length-1?questions[e].answer[i]:questions[e].answer[i]+", ";if($(".feedback").append("<p><strong>Correct answer</strong>: "+t+"</p></div>"),"sa"!==questions[e].type)if(questions[e].correct)""!==String(questions[e].correctFeedback)&&$(".feedback").append("<p><strong>Feedback:</strong> "+questions[e].correctFeedback+"</p>");else if("mc"===questions[e].type){var n=questions[e].wrongFeedback[questions[e].incorrectIndex];"undefined"==typeof n&&(n=""),$(".feedback").append("<p><strong>Feedback:</strong> "+n+"</p>")}else""!==String(questions[e].wrongFeedback)&&$(".feedback").append("<p><strong>Feedback:</strong> "+questions[e].wrongFeedback+"</p>")},$.fn.loadAudioPlayer=function(e,t){var i=640,n=30;"#apcm"===e&&(i=300,n=0),audioPlayer=new MediaElementPlayer(e,{audioWidth:i,audioHeight:n,startVolume:.8,loop:!1,enableAutosize:!0,iPadUseNativeControls:!1,iPhoneUseNativeControls:!1,AndroidUseNativeControls:!1,pauseOtherPlayers:!0,type:"audio/mpeg",success:function(e){sources=[{src:"assets/audio/"+t+".mp3",type:"audio/mpeg"}],e.setSrc(sources),e.load()}})},$.fn.loadNote=function(e){var t=noteArray[e];$("#note").html(t).hide().fadeIn("fast"),$("#note").find("a").length&&$("#note a").each(function(){$(this).attr("target","_blank")})},$.fn.updateSlideNum=function(e){var t=e+1;counter=e,$("#selectable li").each(function(){$(this).removeClass("ui-selected")}),$("#selectable li:nth-child("+t+")").addClass("ui-selected"),$("#currentStatus").html(media+" "+t+" of "+topicCount)},$.fn.bindImgMagnify=function(){$(".magnifyIcon").on("click",function(){$.fancybox.open({href:imgPath,title:imgCaption,helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0})}),$("a#img").fancybox({helpers:{overlay:{css:{background:"rgba(250, 250, 250, 0.85)"}}},padding:0})},$.fn.loadProfilePhoto=function(){var e=new Image,t="assets/pic.jpg";$(e).load(function(){$("#profile .photo").html('<img src="'+t+'" alt="Instructor Photo" border="0" />')}).error(function(){$("#profile .photo").html('<img src="https://mediastreamer.doit.wisc.edu/uwli-ltc/media/storybook_plus/img/profile.png" width="200" height="300" alt="No Profile Photo" border="0" />')}).attr({src:t,border:0})},$.fn.adjustFontSize=function(e){var t=2;"minus"===e?defaultFontSize-=t:"plus"===e&&(defaultFontSize+=t),12>=defaultFontSize?defaultFontSize=12:defaultFontSize>=20&&(defaultFontSize=20),$("#note").removeClass(),12===defaultFontSize?$("#note").addClass("size12"):16===defaultFontSize?$("#note").addClass("size16"):18===defaultFontSize?$("#note").addClass("size18"):20===defaultFontSize&&$("#note").addClass("size20"),$("#fontSizeIndicator").html(defaultFontSize)},$.fn.getDownloadableFile=function(e,t,i){var n=e,s="Audio",a=$("#download_bar ul"),o=window.location.protocol;if("http:"!==o){var r=window.location.href;r=r.substr(0,r.lastIndexOf("/")+1).replace("https","http"),n=r+e}"pdf"===t&&(s="Transcript"),$.fn.fileExists(e,t,i)&&a.append('<li><a href="'+n+"."+t+'" target="_blank"><span class="icon-arrow-down"><span> '+s+"</a></li>")},$.fn.displayGetLessonError=function(e,t){var i,n;switch(e){case 0:i="<strong>Error 0</strong> - Not connect. Please verify network.";break;case 404:i="<strong>Error 404</strong> - Requested page not found.";break;case 406:i="<strong>Error 406</strong> - Not acceptable error.";break;case 500:i="<strong>Error 500</strong> - Internal Server Error.";break;default:i="Unknow error ... "+e}switch(t){case"parsererror":n="Invalid XML. XML parse failed.";break;case"timeout":n="XML parsing timed out.";break;case"abort":n="Ajax request aborted.";break;case"error":n="Failed to get requested source. Most likely a 404 or 406.";break;default:n="Uncaught Error ... "+e.responseText}$("#splash_screen, #player").hide(),$("#errorMsg").html("<p>"+i+"<br />"+n+"</p>")},$.fn.splitSelections=function(e){var t=e.split("|");return t},$.fn.displayErrorMsg=function(e,t){$("#slide").html('<div id="errorMsg"><p><strong>Error:</strong> '+e+"</p><p>"+t+"</p></div>")},$.fn.getDirectory=function(){var e=window.location.href,t;return t=e.split("?"),t=t[0].split("/"),t=t[t.length-2]},$.fn.fileExists=function(e,t,i){var n,s=i;switch(t){case"pdf":s="application/pdf"}return $.ajax({url:e+"."+t,type:"HEAD",dataType:"text",contentType:s,async:!1,beforeSend:function(e){e.overrideMimeType(s),e.setRequestHeader("Accept",s)},success:function(){n=!0},error:function(){n=!1}}),n},$.fn.getParameterByName=function(e){var t="[\\?&]"+e+"=([^&#]*)",i=new RegExp(t),n=i.exec(window.location.href);return e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))},$.fn.addLeadingZero=function(e){return 10>e?"0"+e:e};